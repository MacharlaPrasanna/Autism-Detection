<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assessment Reports</title>
    <!-- Include Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-auth-compat.js"></script>
    <!-- Include jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Previous styles remain the same */
        .user-info {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .user-info h2 {
            color: #333;
            margin-bottom: 15px;
        }

        .user-info p {
            color: #666;
            margin: 5px 0;
        }

        .info-label {
            font-weight: bold;
            display: inline-block;
            width: 120px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1 class="title">Assessment Reports</h1>
                <p class="subtitle">Generate and manage assessment reports</p>
            </div>
            <button onclick="fetchReports()">Refresh Reports</button>
        </div>

        <div id="user-info" class="user-info">
            <h2>User Information</h2>
            <div id="user-details"></div>
        </div>

        <div id="error-message" class="error-message"></div>
        <div id="loading" class="loading">Loading reports...</div>
        <div id="reports-container" class="reports-grid"></div>
    </div>

    <script>
        // Firebase configuration remains the same
        const firebaseConfig = {
            apiKey: "AIzaSyC_8gFPJrjBhjs4Zj5YDyYcoZQjfl6Amr0",
            authDomain: "autism-evaluation-platform.firebaseapp.com",
            projectId: "autism-evaluation-platform",
            storageBucket: "autism-evaluation-platform.appspot.com",
            messagingSenderId: "748226978662",
            appId: "1:748226978662:web:cddef872e6bfc1fb131ea7",
            measurementId: "G-1TGEHTTJF4"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const domainNames = {
            socialRelationship: "Social Relationship and Reciprocity",
            emotionalResponsiveness: "Emotional Responsiveness",
            speechLanguageCommunication: "Speech-Language and Communication",
            behaviourPatterns: "Behavior Patterns",
            sensoryAspects: "Sensory Aspects",
            cognitiveComponent: "Cognitive Component"
        };

        // Display user information
        function displayUserInfo(user) {
            const userDetailsDiv = document.getElementById('user-details');
            const userData = user.providerData[0] || {};
            const displayName = user.displayName || userData.displayName || 'Not provided';
            const email = user.email || userData.email || 'Not provided';
            
            userDetailsDiv.innerHTML = `
                <p><span class="info-label">Name:</span> ${displayName}</p>
                <p><span class="info-label">Email:</span> ${email}</p>
                <p><span class="info-label">User ID:</span> ${user.uid}</p>
            `;

            // Try to fetch additional user data from Firestore
            db.collection('users').doc(user.uid).get()
                .then(doc => {
                    if (doc.exists) {
                        const additionalData = doc.data();
                        userDetailsDiv.innerHTML += `
                            <p><span class="info-label">Organization:</span> ${additionalData.organization || 'Not provided'}</p>
                            <p><span class="info-label">Role:</span> ${additionalData.role || 'Not provided'}</p>
                        `;
                    }
                })
                .catch(error => console.log('Error fetching additional user data:', error));
        }

        async function fetchReports() {
            const loading = document.getElementById('loading');
            const errorMessage = document.getElementById('error-message');
            const reportsContainer = document.getElementById('reports-container');

            loading.style.display = 'block';
            errorMessage.style.display = 'none';
            reportsContainer.innerHTML = '';

            try {
                const user = auth.currentUser;
                if (!user) {
                    throw new Error('No user logged in');
                }

                displayUserInfo(user);

                const assessmentsSnapshot = await db.collection(`users/${user.uid}/assessments`).get();
                
                if (assessmentsSnapshot.empty) {
                    // Create a sample report if no reports exist
                    createSampleReport(user);
                    return;
                }

                for (const doc of assessmentsSnapshot.docs) {
                    if (doc.id.startsWith('assessment_')) {
                        const scores = {};
                        let totalScore = 0;
                        let hasAnyScores = false;

                        // Try to fetch scores for each domain
                        for (const [key, name] of Object.entries(domainNames)) {
                            try {
                                const domainDoc = await db.doc(`users/${user.uid}/assessments/${doc.id}/${key}`).get();
                                if (domainDoc.exists) {
                                    const score = domainDoc.data().score || 0;
                                    scores[key] = score;
                                    totalScore += score;
                                    hasAnyScores = true;
                                } else {
                                    scores[key] = 'N/A';
                                }
                            } catch (error) {
                                console.log(`Error fetching ${key} score:`, error);
                                scores[key] = 'N/A';
                            }
                        }

                        // Create report card even if we only have partial data
                        const reportData = {
                            id: doc.id,
                            scores,
                            totalScore: hasAnyScores ? totalScore : 'N/A',
                            timestamp: doc.data().timestamp?.toDate() || new Date(),
                            userData: {
                                name: user.displayName || 'Not provided',
                                email: user.email || 'Not provided',
                                uid: user.uid
                            }
                        };

                        reportsContainer.appendChild(createReportCard(reportData));
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                createSampleReport(auth.currentUser);
            } finally {
                loading.style.display = 'none';
            }
        }

        function createSampleReport(user) {
            const reportsContainer = document.getElementById('reports-container');
            const sampleReport = {
                id: 'sample_report',
                scores: Object.fromEntries(
                    Object.keys(domainNames).map(key => [key, 'N/A'])
                ),
                totalScore: 'N/A',
                timestamp: new Date(),
                userData: {
                    name: user?.displayName || 'Not provided',
                    email: user?.email || 'Not provided',
                    uid: user?.uid || 'Not provided'
                }
            };
            reportsContainer.appendChild(createReportCard(sampleReport));
        }

        function createReportCard(report) {
            const card = document.createElement('div');
            card.className = 'report-card';

            const header = document.createElement('div');
            header.className = 'report-header';
            header.innerHTML = `
                <div class="report-title">Assessment Report</div>
                <div class="report-date">${report.timestamp.toLocaleDateString()}</div>
            `;

            const scoresContainer = document.createElement('div');
            Object.entries(report.scores).forEach(([domain, score]) => {
                const scoreItem = document.createElement('div');
                scoreItem.className = 'score-item';
                scoreItem.innerHTML = `
                    <span>${domainNames[domain]}</span>
                    <span>${score}</span>
                `;
                scoresContainer.appendChild(scoreItem);
            });

            const totalScore = document.createElement('div');
            totalScore.className = 'total-score';
            totalScore.innerHTML = `
                <span>Total Score</span>
                <span>${report.totalScore}</span>
            `;

            const generateButton = document.createElement('button');
            generateButton.textContent = 'Generate PDF';
            generateButton.style.width = '100%';
            generateButton.style.marginTop = '15px';
            generateButton.onclick = () => generatePDF(report);

            card.appendChild(header);
            card.appendChild(scoresContainer);
            card.appendChild(totalScore);
            card.appendChild(generateButton);

            return card;
        }

        function generatePDF(reportData) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Add title
            doc.setFontSize(20);
            doc.text('Autism Evaluation Report', 20, 20);

            // Add user information
            doc.setFontSize(12);
            let yPos = 40;
            doc.text('User Information:', 20, yPos);
            yPos += 10;

            // Add available user information
            const userInfo = {
                'Name': reportData.userData?.name || 'Not provided',
                'Email': reportData.userData?.email || 'Not provided',
                'User ID': reportData.userData?.uid || 'Not provided',
                'Assessment Date': reportData.timestamp.toLocaleDateString()
            };

            Object.entries(userInfo).forEach(([key, value]) => {
                doc.text(`${key}: ${value}`, 20, yPos);
                yPos += 10;
            });

            // Add scores
            yPos += 10;
            doc.text('Domain Scores:', 20, yPos);
            yPos += 10;

            Object.entries(reportData.scores).forEach(([domain, score]) => {
                doc.text(`${domainNames[domain]}: ${score}`, 20, yPos);
                yPos += 10;
            });

            // Add total score
            yPos += 10;
            doc.setFontSize(14);
            doc.text(`Total Score: ${reportData.totalScore}`, 20, yPos);

            // Save the PDF
            const fileName = `autism-evaluation-${reportData.timestamp.toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
        }

        // Check authentication state and fetch reports
        auth.onAuthStateChanged((user) => {
            if (user) {
                fetchReports();
            } else {
                // Handle not logged in state
                document.getElementById('user-details').innerHTML = '<p>Please log in to view reports.</p>';
            }
        });
    </script>
</body>
</html>