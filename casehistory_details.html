<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Case History</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body {
            background-color: #f4f6f9;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .case-history-container {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
            padding: 40px;
            margin-top: 30px;
        }
        .section-header {
            background-color: #2c3e50;
            color: white;
            padding: 15px;
            margin-bottom: 25px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .section-header h3 {
            margin: 0;
            font-weight: 600;
        }
        .detail-card {
            background-color: #f8f9fa;
            border-left: 4px solid #3498db;
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 5px;
        }
        .detail-label {
            font-weight: 600;
            color: #2c3e50;
        }
        .detail-value {
            color: #34495e;
        }
        .no-data {
            color: #7f8c8d;
            font-style: italic;
        }
        #download-pdf {
            margin-bottom: 20px;
        }
        @media print {
            .case-history-container {
                box-shadow: none;
                margin-top: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container case-history-container">
        <div class="row mb-4">
            <div class="col-12 text-center">
                <h1 class="display-6">Comprehensive Case History</h1>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12 text-center">
                <button id="download-pdf" class="btn btn-primary">
                    <i class="fas fa-download"></i> Download PDF
                </button>
            </div>
        </div>

        <div id="case-history-content"></div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <!-- html2pdf Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- Font Awesome for download icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC_8gFPJrjBhjs4Zj5YDyYcoZQjfl6Amr0",
            authDomain: "autism-evaluation-platform.firebaseapp.com",
            projectId: "autism-evaluation-platform",
            storageBucket: "autism-evaluation-platform.firebasestorage.app",
            messagingSenderId: "748226978662",
            appId: "1:748226978662:web:cddef872e6bfc1fb131ea7",
            measurementId: "G-1TGEHTTJF4"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Mapping of database field names to form labels with specific order
        const fieldMappings = {
            identification: {
                name: 'Name',
                dob: 'Date of Birth', 
                age: 'Age',
                gender: 'Gender',
                informant: 'Informant (Mother/ Father/Guardian with name)',
                parentOccupation: 'Parent\'s Occupation',
                referral: 'Source of Referral',
                communication: 'Child Mode of Communication',
                complaints: 'Presenting Chief Complaints'
            },
            treatment: {
                illnessInjuries: 'Illness/Injuries',
                convulsions: 'Convulsions',
                earAches: 'Ear Aches/Discharge',
                anyOtherMedical: 'Any Other Medical Details'
            },
            educational: {
                schoolAge: 'Age of Beginning of School',
                peerTeacherRelationship: 'Relationship between Peers and Teachers',
                schoolIssues: 'School Phobia/Non-Attendance/Truancy/Reading or Writing Difficulties',
                anyOtherEducational: 'Any Other Educational Details'
            },
            playhistory: {
                motordev: 'Motor Development',
                speechdev: 'Speech & Language Development',
                sensorydev: 'Sensory Development',
                socialdev: 'Social Development',
                playinghistory: 'Play History Details'
            },
            behavior: {
                behave: 'Behavior in Infancy and Toddler',
                hearing: 'Hearing',
                homebehaviour: 'Home Behaviour',
                socialbehaviour: 'Social Behaviour',
                differentbeh: 'Differential Behaviors',
                vision: 'Vision',
                speech: 'Speech',
                orientation: 'Orientation (Time/Place/Person)'
            },
            previousDiagnosis: {
                prevtherapy: 'Previous Diagnosis & Therapy Details',
                recommend: 'Recommendation'
            }
        };

        // Create a section with details
        function createSection(title, data, mappings) {
            if (!data || Object.keys(data).length === 0) {
                return null;
            }

            // Remove timestamp if present
            delete data.timestamp;

            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'mb-4';

            // Section header
            const headerDiv = document.createElement('div');
            headerDiv.className = 'section-header';
            headerDiv.innerHTML = `<h3>${title}</h3>`;
            sectionDiv.appendChild(headerDiv);

            // Create detail cards in the order of mappings
            Object.keys(mappings).forEach(key => {
                const label = mappings[key];
                const value = data[key];
                
                if (value !== undefined && value !== '') {
                    const detailCard = document.createElement('div');
                    detailCard.className = 'detail-card';
                    detailCard.innerHTML = `
                        <div class="row">
                            <div class="col-4 detail-label">${label}</div>
                            <div class="col-8 detail-value">${value || 'Not Provided'}</div>
                        </div>
                    `;
                    sectionDiv.appendChild(detailCard);
                }
            });

            return sectionDiv;
        }

        // Fetch case history details
        function fetchCaseHistory() {
            const urlParams = new URLSearchParams(window.location.search);
            const parentId = urlParams.get('id');
            const contentContainer = document.getElementById('case-history-content');

            if (!parentId) {
                alert('No parent ID provided');
                return;
            }

            // Sections to fetch in specific order
            const sections = [
                { name: 'Identification Data', doc: 'identification', mappings: fieldMappings.identification },
                { name: 'Treatment and Medical History', doc: 'treatment', mappings: fieldMappings.treatment },
                { name: 'Educational History', doc: 'educational', mappings: fieldMappings.educational },
                { name: 'Play History', doc: 'playhistory', mappings: fieldMappings.playhistory },
                { name: 'Behavioral History', doc: 'behavior', mappings: fieldMappings.behavior },
                { name: 'Previous Diagnosis', doc: 'previousDiagnosis', mappings: fieldMappings.previousDiagnosis }
            ];

            // Fetch all sections
            sections.forEach(section => {
                db.collection('users')
                  .doc(parentId)
                  .collection('casehistory')
                  .doc(section.doc)
                  .get()
                  .then(doc => {
                      if (doc.exists) {
                          const sectionElement = createSection(section.name, doc.data(), section.mappings);
                          if (sectionElement) {
                              contentContainer.appendChild(sectionElement);
                          }
                      }
                  })
                  .catch(error => {
                      console.error(`Error fetching ${section.name}:`, error);
                  });
            });
        }

        // PDF Download Function
        function downloadPDF() {
        const urlParams = new URLSearchParams(window.location.search);
        const parentId = urlParams.get('id');

        // Collect all sections data
        const sections = [
            { name: 'identification', title: 'Identification Data', mappings: fieldMappings.identification },
            { name: 'treatment', title: 'Treatment and Medical History', mappings: fieldMappings.treatment },
            { name: 'educational', title: 'Educational History', mappings: fieldMappings.educational },
            { name: 'playhistory', title: 'Play History', mappings: fieldMappings.playhistory },
            { name: 'behavior', title: 'Behavioral History', mappings: fieldMappings.behavior },
            { name: 'previousDiagnosis', title: 'Previous Diagnosis', mappings: fieldMappings.previousDiagnosis }
        ];

        // Function to fetch all sections
        function fetchAllSections() {
            return Promise.all(sections.map(section => 
                db.collection('users')
                  .doc(parentId)
                  .collection('casehistory')
                  .doc(section.name)
                  .get()
            ));
        }

        function generateProfessionalPDF(sectionDocs) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
        orientation: 'portrait',
        unit: 'mm',
        format: 'a4'
    });

    // Define colors
    const colors = {
        primary: [41, 128, 185],    // Blue
        secondary: [52, 73, 94],   // Dark gray
        text: [51, 51, 51],        // Dark text
        subtext: [102, 102, 102]   // Gray text
    };

    // Define consistent margins
    const margins = {
        top: 20,
        left: 20,
        right: 20,
        bottom: 20
    };

    let currentPage = 1;
    let yPosition = margins.top;

    // Add header function
    function addHeader() {
        doc.setFillColor(41, 128, 185);
        doc.rect(0, 0, 210, 12, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(10);
        const today = new Date().toLocaleDateString();
        doc.text(`Generated on: ${today}`, margins.left, 8);
        doc.text(`Page ${currentPage}`, 180, 8);
    }

    // Add footer function
    function addFooter() {
        doc.setFillColor(41, 128, 185);
        doc.rect(0, 287, 210, 10, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(8);
        doc.text('Case History', margins.left, 293);
    }

    // Initialize first page
    addHeader();
    addFooter();

    // Add title
    yPosition = 40;
    doc.setFontSize(24);
    doc.setTextColor(...colors.primary);
    doc.setFont('helvetica', 'bold');
    doc.text('Comprehensive Case History', doc.internal.pageSize.getWidth() / 2, yPosition, { align: 'center' });

    // Add decorative line under title
    yPosition += 3;
    doc.setDrawColor(...colors.primary);
    doc.setLineWidth(0.5);
    doc.line(40, yPosition, 170, yPosition);
    yPosition += 10;

    // Process each section
    sections.forEach((section, index) => {
        const sectionDoc = sectionDocs[index];

        if (sectionDoc.exists) {
            const data = sectionDoc.data();
            delete data.timestamp;

            // Check if we need a new page
            if (yPosition > 250) {
                doc.addPage();
                currentPage++;
                addHeader();
                addFooter();
                yPosition = margins.top + 15;
            }

            // Section Title with background

            const backgroundHeight = 8; // Compact height
            doc.setFillColor(245, 247, 250);
            doc.rect(margins.left - 2, yPosition - (backgroundHeight - 1), 172, backgroundHeight, 'F');
            doc.setFontSize(14);
            doc.setTextColor(...colors.secondary);
            doc.setFont('helvetica', 'bold');
            doc.text(section.title, margins.left, yPosition);
            yPosition += 8;

            // Section Details
            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');

            Object.keys(section.mappings).forEach(key => {
                const label = section.mappings[key];
                const value = data[key];

                if (value !== undefined && value !== '') {
                    // Label in bold
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...colors.text);

                    // Format and wrap text
                    const labelText = `${label}:`;
                    const labelWidth = doc.getTextWidth(labelText) + 5; // Add padding
                    doc.text(labelText, margins.left, yPosition);

                    // Value in normal font
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(...colors.subtext);
                    const valueWidth = doc.internal.pageSize.getWidth() - margins.left - margins.right - labelWidth;
                    const wrappedText = doc.splitTextToSize(value, valueWidth);

                    // Indent wrapped lines
                    wrappedText.forEach((line, i) => {
                        const xPos = i === 0 ? margins.left + labelWidth : margins.left + 10; // Add padding for readability
                        doc.text(line, xPos, yPosition);
                        yPosition += 6;
                    });

                    yPosition += 2;

                    // Check for page break
                    if (yPosition > 270) {
                        doc.addPage();
                        currentPage++;
                        addHeader();
                        addFooter();
                        yPosition = margins.top + 15;
                    }
                }
            });

            yPosition += 5;
        }
    });

    // Save the PDF with a formatted name
    const timestamp = new Date().toISOString().split('T')[0];
    doc.save(`Case_History_${timestamp}.pdf`);
}

// Fetch and generate PDF
fetchAllSections()
    .then(generateProfessionalPDF)
    .catch(error => {
        console.error('Error generating PDF:', error);
        alert('Failed to generate PDF. Please try again.');
    });
        }

    // Add additional script to load jsPDF
    const jsPDFScript = document.createElement('script');
    jsPDFScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
    document.head.appendChild(jsPDFScript);

        // Add PDF Download Event Listener
        document.addEventListener('DOMContentLoaded', () => {
            const downloadBtn = document.getElementById('download-pdf');
            downloadBtn.addEventListener('click', downloadPDF);
        });

        // Authentication and Fetch
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                fetchCaseHistory();
            } else {
                alert('Please log in');
                window.location.href = 'login.html';
            }
        });
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>