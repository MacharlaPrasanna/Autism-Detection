<!DOCTYPE html>
<html lang="te">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            background-color: #f5f5f5;
        }

        .container {
            width: 95%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
            background-color: #b200ff29;
        }

        h1 {
            color: black;
            text-align: center;
            font-size: clamp(1.5rem, 4vw, 2rem);
            margin: 1rem 0;
        }

        .score-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(100%, 250px), 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .score-card {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.2s;
        }

        .score-card:hover {
            transform: translateY(-2px);
        }

        .score-title {
            font-size: clamp(0.875rem, 2vw, 1rem);
            color: #666;
            margin-bottom: 0.5rem;
        }

        .score-value {
            font-size: clamp(1.25rem, 3vw, 1.5rem);
            font-weight: bold;
            color: #333;
        }

        .score-max {
            font-size: clamp(0.875rem, 2vw, 1rem);
            color: #666;
        }

        .chart-container {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 1.5rem 0;
            position: relative;
            width: 100%;
            min-height: 300px;
            height: auto;
        }

        #severity-indicator {
            text-align: center;
            padding: 0.75rem;
            margin: 1rem 0;
            border-radius: 8px;
            font-weight: bold;
            font-size: clamp(1rem, 2.5vw, 1.25rem);
        }

        #loading {
            text-align: center;
            padding: 1rem;
            font-style: italic;
            color: #666;
        }

        .error {
            color: #ef4444;
            text-align: center;
            padding: 0.75rem;
            margin: 0.75rem 0;
            background: #fecaca;
            border-radius: 8px;
            font-size: clamp(0.875rem, 2vw, 1rem);
        }
    </style>
    <title>ప్రదర్శన ఫలితాలు</title>
</head>
<body>
    <div class="container">
        <h1>ప్రదర్శన ఫలితాలు</h1>
        <div id="loading">స్కోర్లు లోడ్ అవుతున్నాయి...</div>
        <div id="error" style="display: none;" class="error"></div>
        
        <div class="score-grid">
            <div class="score-card">
                <div class="score-title">సామాజిక సంబంధాలు</div>
                <div class="score-value">-<span class="score-max"></span></div>
            </div>
            <div class="score-card">
                <div class="score-title">భావోద్వేగ స్పందన</div>
                <div class="score-value">-<span class="score-max"></span></div>
            </div>
            <div class="score-card">
                <div class="score-title">మాట్లాడటం & సంభాషణ</div>
                <div class="score-value">-<span class="score-max"></span></div>
            </div>
            <div class="score-card">
                <div class="score-title">ప్రవర్తన విధానాలు</div>
                <div class="score-value">-<span class="score-max"></span></div>
            </div>
            <div class="score-card">
                <div class="score-title">భావన అంశాలు</div>
                <div class="score-value">-<span class="score-max"></span></div>
            </div>
            <div class="score-card">
                <div class="score-title">జ్ఞాన భాగం</div>
                <div class="score-value">-<span class="score-max"></span></div>
            </div>
        </div>

        <div id="severity-indicator"></div>

        <div class="chart-container">
            <canvas id="scoreChart"></canvas>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC_8gFPJrjBhjs4Zj5YDyYcoZQjfl6Amr0",
            authDomain: "autism-evaluation-platform.firebaseapp.com",
            projectId: "autism-evaluation-platform",
            storageBucket: "autism-evaluation-platform.appspot.com",
            messagingSenderId: "748226978662",
            appId: "1:748226978662:web:cddef872e6bfc1fb131ea7",
            measurementId: "G-1TGEHTTJF4"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Domain definitions in Telugu
        const domains = [
        { id: 'socialRelationship', name: 'సామాజిక సంబంధాలు', max: 45 },
    { id: 'emotionalResponsiveness', name: 'భావోద్వేగ స్పందన', max: 25 },
    { id: 'speechLanguageCommunication', name: 'మాట్లాడటం & సంభాషణ', max: 45 },
    { id: 'behaviourPatterns', name: 'ప్రవర్తన విధానాలు', max: 35 },
    { id: 'sensoryAspects', name: 'సంవేదన అంశాలు', max: 30 },
    { id: 'cognitiveComponent', name: 'జ్ఞాన భాగం', max: 20 }
        ];

        let chart = null;

        // Function to update scores display
        function updateScores(scores) {
            const scoreCards = document.querySelectorAll('.score-card');
            scoreCards.forEach((card, index) => {
                const scoreValue = card.querySelector('.score-value');
                scoreValue.innerHTML = `${scores[index]}<span class="score-max">/${domains[index].max}</span>`;
            });

            const totalScore = scores.reduce((a, b) => a + b, 0);
            const severityIndicator = document.getElementById('severity-indicator');
            let severity, color;

            if (totalScore <= 70) {
                severity = 'ఆటిజం లేదు';
                color = '#4ade80';
            } else if (totalScore <= 106) {
                severity = 'స్వల్ప ఆటిజం';
                color = '#fbbf24';
            } else if (totalScore <= 153) {
                severity = 'మధ్యస్థ ఆటిజం';
                color = '#fb923c';
            } else {
                severity = 'తీవ్ర ఆటిజం';
                color = '#ef4444';
            }

            severityIndicator.textContent = `${severity} (మొత్తం స్కోరు: ${totalScore})`;
            severityIndicator.style.backgroundColor = color + '20';
            severityIndicator.style.color = color;

            if (chart) {
                chart.destroy();
            }

            const ctx = document.getElementById('scoreChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: domains.map(d => d.name),
                    datasets: [
                        {
                            label: 'స్కోరు',
                            data: scores,
                            backgroundColor: color,
                            borderColor: color,
                            borderWidth: 1,
                            borderRadius: 5,
                        },
                        {
                            label: 'గరిష్ఠ స్కోరు',
                            data: domains.map(d => d.max),
                            backgroundColor: '#e5e7eb',
                            borderColor: '#d1d5db',
                            borderWidth: 1,
                            borderRadius: 5,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: Math.max(...domains.map(d => d.max)) + 10
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                color: '#000'
                            }
                        }
                    }
                }
            });
        }

        // Fetch scores from Firebase
        async function fetchScores() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            
            try {
                const user = auth.currentUser;
                if (!user) throw new Error('ఏ వినియోగదారుడు లాగిన్ కాలేదు');

                const scores = [];
                for (const domain of domains) {
                    const docRef = db.collection('users').doc(user.uid)
                                   .collection('Questionnaire').doc(domain.id);
                    const docSnap = await docRef.get();
                    scores.push(docSnap.exists ? docSnap.data().score || 0 : 0);
                }

                loading.style.display = 'none';
                error.style.display = 'none';
                updateScores(scores);
            } catch (err) {
                console.error('లోపం:', err);
                loading.style.display = 'none';
                error.style.display = 'block';
                error.textContent = 'లోడింగ్ లో లోపం, పేజీని రీఫ్రెష్ చేయండి.';
            }
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                fetchScores();
            } else {
                window.location.href = 'index.html';
            }
        });
    </script>
</body>
</html>
