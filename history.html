<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
        <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-auth-compat.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <style>
            body {
                font-family: 'Arial', sans-serif;
                background-color: #c58acd99;
                color: #333;
                padding-top: 20px;
            }
    
            h1 {
                font-size: 2rem;
                text-align: center;
                margin-bottom: 1.5rem;
                color: #000000;
                font-weight: bold;
            }
    
            .submission-card {
                background-color: #ffffff;
                border: none;
                border-radius: 10px;
                padding: 15px;
                margin-bottom: 20px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                transition: transform 0.3s ease-in-out;
            }
    
            .submission-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            }
    
            .submission-card h3 {
                font-size: 1.25rem;
                font-weight: bold;
                color: #fd0000;
            }
    
            .submission-card p {
                margin-bottom: 0.5rem;
                font-size: 1rem;
                font-weight: bold;
                color: #000000;
            }
    
            #loading {
                text-align: center;
                color: #0d6efd;
                font-style: italic;
                font-size: 1.2rem;
                margin-top: 20px;
            }
    
            .error {
                color: #dc3545;
                text-align: center;
                margin: 20px 0;
                font-size: 1.2rem;
            }
    
            .home-button {
                position: absolute;
                top: 20px;
                right: 20px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <a href="parent_dashboard_en.html" class="btn btn-primary home-button">Home</a>
            <h1>Visualization Reports</h1>
            <div id="submissionsContainer"></div>
            <div id="loading">Loading submissions...</div>
            <div id="error" class="error" style="display: none;">Error loading submissions. Please refresh the page.</div>
        </div>
    
        <script>
            // Firebase configuration
            const firebaseConfig = {
                apiKey: "AIzaSyC_8gFPJrjBhjs4Zj5YDyYcoZQjfl6Amr0",
                authDomain: "autism-evaluation-platform.firebaseapp.com",
                projectId: "autism-evaluation-platform",
                storageBucket: "autism-evaluation-platform.appspot.com",
                messagingSenderId: "748226978662",
                appId: "1:748226978662:web:cddef872e6bfc1fb131ea7",
                measurementId: "G-1TGEHTTJF4"
            };
    
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const auth = firebase.auth();
    
            const domainLimits = {
                'behaviourPatterns': { min: 7, max: 35 },
        'sensoryAspects': { min: 6, max: 30 },
        'cognitiveComponent': { min: 4, max: 20 },
        'socialRelationship': { min: 9, max: 45 },
        'emotionalResponsiveness': { min:5, max: 25 },
        'speechLanguageCommunication': {min:9,max:45}
            };
    
            function createGroupedBarChart(canvas, labels, actualData, maxScores, minScores) {
                return new Chart(canvas, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Minimum Score',
                                data: minScores,
                                backgroundColor: 'rgba(25, 135, 84, 0.7)', // Green
                                borderColor: '#198754',
                                borderWidth: 1
                            },
                            {
                                label: 'Current Score',
                                data: actualData,
                                backgroundColor: 'rgba(88, 21, 28, 0.7)', // Burgundy
                                borderColor: '#58151c',
                                borderWidth: 1
                            },
                            {
                                label: 'Maximum Score',
                                data: maxScores,
                                backgroundColor: 'rgba(220, 53, 69, 0.7)', // Red
                                borderColor: '#dc3545',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                beginAtZero: true,
                                max: Math.max(...maxScores) + 2,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    padding: 20,
                                    font: {
                                        size: 12,
                                        weight: 'bold'
                                    }
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: '#fff',
                                borderWidth: 1,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        label += context.parsed.y.toFixed(1);
                                        return label;
                                    }
                                }
                            }
                        },
                        barPercentage: 0.8,
                        categoryPercentage: 0.9
                    }
                });
            }
    
            async function displaySubmissionsWithReport(userId) {
                const submissionsContainer = document.getElementById('submissionsContainer');
                const loading = document.getElementById('loading');
                const error = document.getElementById('error');
    
                try {
                    loading.style.display = 'block';
                    error.style.display = 'none';
                    submissionsContainer.innerHTML = '';
    
                    const submissionsRef = db.collection('users').doc(userId).collection('submissions');
                    const submissionsSnap = await submissionsRef.orderBy('submittedAt', 'desc').get();
    
                    if (submissionsSnap.empty) {
                        loading.style.display = 'none';
                        error.style.display = 'block';
                        error.textContent = 'No submissions found.';
                        return;
                    }
    
                    submissionsSnap.forEach(doc => {
                        const data = doc.data();
                        if (!data.scores || Object.keys(data.scores).length === 0) return;
    
                        const submissionCard = document.createElement('div');
                        submissionCard.classList.add('submission-card');
    
                        const scores = data.scores;
                        const chartLabels = Object.keys(scores).sort();
                        const chartData = chartLabels.map(label => scores[label]);
                        const maxScores = chartLabels.map(label => domainLimits[label]?.max || 40);
                        const minScores = chartLabels.map(label => domainLimits[label]?.min || 0);
    
                        const reportHTML = `
                            <h3><strong>Student Name: ${data.studentName || 'Unknown'}</strong></h3>
                            <h3><strong>Student Age: ${data.studentAge || 'Unknown'}</strong></h3>
                            <h3><strong>Student DOB: ${data.studentDob || 'Unknown'}</strong></h3>
                            <h3><strong>Autism Range: ${data.autismRange}</strong></h3>
                            <p><strong>Total Score:</strong> ${data.totalScore}</p>
                            <p><strong>Percentage Score:</strong> ${data.percentageScore}</p>
                            <p><strong>Submission Date:</strong> ${data.submittedAt.toDate().toLocaleString()}</p>
                        `;
    
                        const canvas = document.createElement('canvas');
                        canvas.id = 'chart-' + doc.id;
    
                        submissionCard.innerHTML = reportHTML;
                        submissionCard.appendChild(canvas);
                        submissionsContainer.appendChild(submissionCard);
    
                        createGroupedBarChart(canvas, chartLabels, chartData, maxScores, minScores);
                    });
    
                    loading.style.display = 'none';
                } catch (err) {
                    console.error('Error fetching submissions:', err);
                    loading.style.display = 'none';
                    error.style.display = 'block';
                }
            }
    
            auth.onAuthStateChanged(user => {
                if (user) {
                    displaySubmissionsWithReport(user.uid);
                } else {
                    window.location.href = 'login.html';
                }
            });
        </script>
    </body>
    </html>